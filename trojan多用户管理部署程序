#!/bin/bash

echo -e "\n欢迎使用喵哥一键trojan安装管理程序！\n"
echo -e "本程序支持在线web页面和命令行两种方式管理trojan多用户，"
echo -e "同时支持流量统计和流量限制功能，"
echo -e "并且支持命令行模式管理，命令补全更是让操作更加便捷。\n"
echo -e "另外，本程序集成了acme.sh证书申请功能，"
echo -e "可以轻松申请SSL证书，让网站安全加密。\n"
echo -e "您还可以通过本程序生成客户端配置文件，"
echo -e "在线实时查看trojan日志，随时切换在线trojan和trojan-go，"
echo -e "以及分享trojan://链接和二维码，方便快捷地分享链接。\n"
echo -e "最后，本程序还支持将trojan链接转化为clash订阅地址，"
echo -e "并且导入到clash_for_windows中，使用更加方便。\n"
echo -e "感谢您使用喵哥一键trojan安装管理程序！\n"

# 全局变量定义
trojan_conf_path="/etc/trojan/config.json"
trojan_go_conf_path="/etc/trojan-go/config.json"
trojan_service_name="trojan"
trojan_go_service_name="trojan-go"

# 配置文件路径定义
user_conf_dir="/etc/trojan/user-conf"
user_conf_file_suffix="-trojan-user.json"

# 日志文件路径定义
trojan_log_file="/var/log/trojan/trojan.log"
trojan_go_log_file="/var/log/trojan-go/trojan-go.log"

# 安装必要的软件包
function install_dependencies() {
    apt update
    apt install -y curl wget jq net-tools
}

# 安装trojan
function install_trojan() {
    # 获取最新版本的trojan二进制文件
    latest_version=$(curl -s https://api.github.com/repos/trojan-gfw/trojan/releases/latest | jq -r '.tag_name')
    wget https://github.com/trojan-gfw/trojan/releases/download/$latest_version/trojan-$latest_version-linux-amd64.tar.xz
    tar xf trojan-$latest_version-linux-amd64.tar.xz
    
    # 复制trojan二进制文件到/usr/local/bin目录下
    cp trojan-$latest_version/trojan /usr/local/bin/
    
    # 创建trojan服务文件
    cat > /etc/systemd/system/$trojan_service_name.service <<EOF
[Unit]
Description=trojan service
After=network.target

[Service]
ExecStart=/usr/local/bin/trojan -c $trojan_conf_path
Restart=on-failure
LimitNOFILE=512000

[Install]
WantedBy=multi-user.target
EOF

    # 启动trojan服务
    systemctl daemon-reload
    systemctl enable $trojan_service_name
    systemctl start $trojan_service_name
}

# 安装trojan-go
function install_trojan_go() {
    # 获取最新版本的trojan-go二进制文件
    latest_version=$(curl -s https://api.github.com/repos/p4gefau1t/trojan-go/releases/latest | jq -r '.tag_name')
    wget https://github.com/p4gefau1t/trojan-go/releases/download/$latest_version/trojan-go-linux-amd64.zip
    unzip trojan-go-linux-amd64.zip
    
    # 复制trojan-go二进制文件到/usr/local/bin目录下
    cp trojan-go /usr/local/bin/
    
    # 创建trojan-go服务文件
    cat > /etc/systemd/system/$trojan_go_service_name.service <<EOF
[Unit]
Description=trojan-go service
After=network.target

[Service]
ExecStart=/usr/local/bin/trojan-go -config $trojan_go_conf_path
Restart=on-failure
LimitNOFILE=512000

[Install]
WantedBy=multi-user.target
EOF

    # 启动trojan-go服务
    systemctl daemon-reload
    systemctl enable $trojan_go_service_name
    systemctl start $trojan_go_service_name
}

# 生成用户配置文件
function generate_user_conf

# 安装trojan
function install_trojan() {
  # 安装依赖
  apt-get update
  apt-get install -y socat

  # 下载trojan
  wget https://github.com/trojan-gfw/trojan/releases/download/v1.16.0/trojan-1.16.0-linux-amd64.tar.xz
  tar xf trojan-1.16.0-linux-amd64.tar.xz
  mv trojan/trojan /usr/local/bin
  mv trojan/trojan.service /etc/systemd/system/
  systemctl enable trojan.service
}

# 安装acme.sh
function install_acme() {
  # 下载acme.sh
  curl https://get.acme.sh | sh

  # 申请证书
  ~/.acme.sh/acme.sh --issue -d example.com --nginx
}

# 生成客户端配置文件
function gen_client_config() {
  # 生成配置文件
  cat <<EOF > /etc/trojan/config-client.json
  {
    "run_type": "client",
    "local_addr": "0.0.0.0",
    "local_port": 1080,
    "remote_addr": "your-server-ip",
    "remote_port": 443,
    "password": "your-password",
    "log_level": 1,
    "ssl": {
      "verify": true,
      "verify_hostname": true,
      "cert": "/etc/trojan/cert.crt"
    }
  }
  EOF
}

# 在线查看trojan日志
function view_trojan_log() {
  journalctl -u trojan.service -f
}

# 切换trojan和trojan-go
function switch_trojan_version() {
  # 切换到trojan
  systemctl stop trojan-go.service
  systemctl start trojan.service

  # 切换到trojan-go
  systemctl stop trojan.service
  systemctl start trojan-go.service
}

# 转化为clash订阅地址并导入到clash_for_windows
function gen_clash_subscription() {
  # 生成clash配置文件
  cat <<EOF > /etc/clash/config.yaml
  proxies:
    - name: "trojan"
      type: "trojan"
      server: "your-server-ip"
      port: 443
      password: "your-password"
      tls: true
      skip-cert-verify: true
  EOF

  # 转化为clash订阅地址
  clash_url=$(clash -d /etc/clash convert clash)
  
  # 导入到clash_for_windows
  # TODO: 实现导入逻辑
}

# 主函数
function main() {
  # 安装trojan
  install_trojan

  # 安装acme.sh
  install_acme

  # 生成客户端配置文件
  gen_client_config

  # 在线查看trojan日志
  view_trojan_log

  # 切换trojan和trojan-go
  switch_trojan_version

  # 转化为clash订阅地址并导入到clash_for_windows
  gen_clash_subscription
}

main "$@"
